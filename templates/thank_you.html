{% extends 'base.html' %}

{% block title %}خدمة شحن الرصيد - شكراً لك{% endblock %}

{% block head %}
<script>
    // عند تحميل الصفحة
    window.onload = function() {
        // الحصول على الروابط والرسائل من الخادم
        var whatsappMessage = `{{ whatsapp_message|replace('\n', '\\n')|safe }}`;
        var primaryUrl = "{{ whatsapp_url_alt }}";  // رابط wa.me
        var fallbackUrl = "{{ whatsapp_url }}";     // رابط api.whatsapp.com

        console.log("رسالة الواتساب:", whatsappMessage);
        console.log("رابط الواتساب الأساسي:", primaryUrl);
        console.log("رابط الواتساب الاحتياطي:", fallbackUrl);

        // التحقق من وجود الرسالة
        if (!whatsappMessage || whatsappMessage.includes("لم يتم العثور على تفاصيل الطلب")) {
            console.error("لم يتم العثور على تفاصيل الطلب!");
        }

        // تحديث عناصر الصفحة بالروابط
        setTimeout(function() {
            // تحديث زر الواتساب الرئيسي
            var mainButton = document.getElementById('whatsapp-button');
            if (mainButton) {
                mainButton.setAttribute('data-url', primaryUrl);
                mainButton.setAttribute('data-fallback', fallbackUrl);
                console.log("تم تحديث زر الواتساب الرئيسي");
            }

            // تحديث الرابط الاحتياطي
            var altLink = document.getElementById('whatsapp-link-alt');
            if (altLink) {
                altLink.setAttribute('data-url', primaryUrl);
                altLink.setAttribute('data-fallback', fallbackUrl);
                console.log("تم تحديث رابط الواتساب الاحتياطي");
            }

            // التوجيه التلقائي إلى الواتساب بعد 3 ثوانٍ
            setTimeout(function() {
                console.log("جاري التوجيه التلقائي إلى الواتساب...");
                sendWhatsApp(); // استدعاء دالة إرسال الواتساب
            }, 3000); // انتظار 3 ثوانٍ قبل التوجيه
        }, 500); // انتظار نصف ثانية للتأكد من تحميل الصفحة
    }
</script>
{% endblock %}

{% block content %}
<div class="thank-you">
    <h2>شكراً لطلبك!</h2>
    <div class="alert alert-success mb-4">
        <p>تم استلام طلبك بنجاح.</p>
        <p><strong>لن يتم شحن رصيدك إلا بعد إرسال تفاصيل الطلب و اسكرين بالتحويل على الواتساب.</strong></p>
        <div class="text-center mt-3">
            <i class="bi bi-arrow-down fs-1 text-success animate__animated animate__bounce animate__infinite"></i>
        </div>
    </div>

    <div class="d-grid gap-3 mb-4">
        <!-- زر إرسال تفاصيل الطلب عبر واتساب -->
        <a href="#" id="whatsapp-button"
           onclick="sendWhatsApp()"
           class="btn btn-success btn-lg">
            <i class="bi bi-whatsapp me-2"></i>إرسال تفاصيل الطلب عبر واتساب
        </a>
    </div>

    <!-- رابط احتياطي في حالة عدم عمل الزر الأول -->
    <div class="text-center mb-3">
        <small>إذا لم يعمل الزر أعلاه، يمكنك <a href="#" id="whatsapp-link-alt" onclick="sendWhatsApp()">الضغط هنا</a></small>
    </div>

    <script>
        // دالة لإرسال رسالة واتساب
        function sendWhatsApp() {
            // الحصول على الروابط من السمات أو استخدام الروابط المباشرة
            var button = document.getElementById('whatsapp-button');
            var primaryUrl = button ? button.getAttribute('data-url') : "{{ whatsapp_url_alt }}";
            var fallbackUrl = button ? button.getAttribute('data-fallback') : "{{ whatsapp_url }}";

            console.log("محاولة فتح رابط الواتساب الأساسي:", primaryUrl);

            try {
                // محاولة فتح الرابط في نافذة جديدة
                var newWindow = window.open(primaryUrl, '_blank');

                // التحقق من نجاح فتح النافذة
                if (!newWindow || newWindow.closed || typeof newWindow.closed=='undefined') {
                    console.log("فشل فتح الرابط الأساسي، جاري استخدام الرابط الاحتياطي");
                    // إذا فشل، استخدم رابط بديل
                    window.location.href = fallbackUrl;
                }
            } catch (e) {
                console.error("حدث خطأ أثناء فتح رابط الواتساب:", e);
                // في حالة حدوث خطأ، استخدم الرابط الاحتياطي
                window.location.href = fallbackUrl;
            }

            return false;
        }
    </script>

    <!-- للتأكد من وجود الروابط (مخفي) -->
    <div style="display: none;">
        <div id="whatsapp-url-primary-debug">{{ whatsapp_url_alt }}</div>
        <div id="whatsapp-url-fallback-debug">{{ whatsapp_url }}</div>
    </div>

    <!-- للتأكد من وجود الرسالة (مخفي) -->
    <div style="display: none;" id="whatsapp-message-debug">
        {{ whatsapp_message }}
    </div>

    <!-- للتأكد من وجود الرابط (مخفي) -->
    <div style="display: none;" id="whatsapp-url-debug">
        {{ whatsapp_url }}
    </div>

    <p>سيتم شحن رصيدك خلال بضع دقائق و خلال 30 دقيقة كحد أقصى من وقت تأكيد التحويل.</p>



    <div class="alert alert-danger mb-4">
        <p><strong>تحذير:</strong> يرجى العلم أن أي تعديل في رسالة الطلب تؤدي إلى حظر رقمك نهائياً.</p>
    </div>

    <div class="alert alert-info mb-4">
        <p>إذا كان لديك أي استفسار، يرجى التواصل معنا على الواتساب: <strong>+201012874414</strong></p>
    </div>

    <a href="{{ url_for('index') }}" class="btn btn-primary">العودة للصفحة الرئيسية</a>
</div>
{% endblock %}
